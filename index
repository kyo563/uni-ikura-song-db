<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>歌唱曲一覧（スマホ対応・コピー可）</title>
<style>
  body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; margin:12px; }
  .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
  .row { display:flex; gap:8px; align-items:center; }
  .row>* { flex:1; }
  input[type="search"], select { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:16px; }
  .pill { display:inline-flex; gap:8px; background:#f6f6f6; border-radius:999px; padding:6px; margin:8px 0; }
  .pill label { padding:6px 10px; border-radius:999px; }
  .pill input[type="radio"]{ display:none; }
  .pill input[type="radio"]:checked + span { background:#fff; border:1px solid #ddd; border-radius:999px; }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  th,td { border-bottom:1px solid #eee; padding:8px 6px; font-size:14px; word-break:break-word; vertical-align:top; }
  th { position:sticky; top:0; background:#fafafa; z-index:1; }
  .muted { color:#999; font-size:12px; }
  .btn { appearance:none; border:1px solid #ddd; background:#fff; border-radius:10px; padding:6px 10px; font-size:14px; }
  .btn:active { transform:translateY(1px); }
  .toast { position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; padding:8px 12px; border-radius:8px; font-size:13px; opacity:0; transition:opacity .2s; }
  .toast.show { opacity:1; }
</style>
</head>
<body>

<div class="card">
  <div class="row">
    <input id="q" type="search" placeholder="曲名／アーティスト名で検索（例：群青日和／椎名林檎）" autocomplete="off">
  </div>
  <div class="row">
    <select id="limit" style="max-width:140px;">
      <option value="50">上限 50件</option>
      <option value="100">上限 100件</option>
      <option value="200" selected>上限 200件</option>
      <option value="1000">上限 1000件</option>
    </select>
    <div class="pill">
      <label><input type="radio" name="mode" value="contains" checked><span>部分一致</span></label>
      <label><input type="radio" name="mode" value="prefix"><span>前方一致</span></label>
    </div>
  </div>
  <div class="muted" id="status">読み込み中…</div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="muted" id="hint">検索結果がここに表示されます。</div>
  <div id="table"></div>
</div>

<div id="toast" class="toast">コピーしました</div>

<script>
  // ===== 設定（SHEET_IDは反映済み。GIDは仮の 0。必要に応じて差し替え） =====
  const SHEET_ID = '1Rr1pYbfVcj0ae5EhzIsK8UbEIIE0cUz-00zjruxZQK0';
  const GID = '0'; // ← 表示したいタブを開いたURLの gid= の数字に置き換えてください
  const MAX_FETCH_ROWS = 5000;

  function buildGvizUrl() {
    // 列は A,B,C,D（アーティスト/曲名/備考/直リンク）を想定
    const tq = encodeURIComponent(`select A,B,C,D limit ${MAX_FETCH_ROWS}`);
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json;responseHandler:onGviz&tq=${tq}`;
  }

  const state = { rows: [], debounce: null };

  function onGviz(resp) {
    try {
      const table = resp.table;
      const rows = (table.rows || []).map(r => {
        const a = (r.c[0] && r.c[0].v) || ''; // アーティスト
        const t = (r.c[1] && r.c[1].v) || ''; // 曲名
        const n = (r.c[2] && r.c[2].v) || ''; // 備考
        const l = (r.c[3] && r.c[3].v) || ''; // 直リンク
        return [a, t, n, l];
      });
      state.rows = rows;
      $('status').textContent = `読み込み完了：${rows.length}件`;
      render();
    } catch (e) {
      $('status').textContent = '読み込みに失敗しました';
      console.error(e);
    }
  }
  window.onGviz = onGviz;

  function normalize(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim(); }
  function scheduleSearch(){ clearTimeout(state.debounce); state.debounce = setTimeout(render, 200); }

  function render(){
    const container = $('table'); container.innerHTML = '';
    const hint = $('hint');

    const q = normalize($('q').value || '');
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const limit = parseInt($('limit').value, 10);

    let filtered = state.rows;
    if (q) {
      filtered = filtered.filter(([artist, title]) => {
        const a = normalize(artist), t = normalize(title);
        return mode === 'prefix' ? (a.startsWith(q) || t.startsWith(q)) : (a.includes(q) || t.includes(q));
      });
    }
    const rows = filtered.slice(0, limit);

    $('status').textContent = q ? `${rows.length}件ヒット（全${filtered.length}件）` : `表示中 ${rows.length}件（全${state.rows.length}件）`;
    if (rows.length === 0) { hint.textContent = q ? '該当なし' : '検索結果がここに表示されます。'; return; }
    hint.textContent = '';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['アーティスト名','曲名','備考','歌枠直リンク','コピー'].forEach(h=>{
      const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
    });
    thead.appendChild(trh); table.appendChild(thead);

    const tbody = document.createElement('tbody');
    rows.forEach(([artist, title, note, link])=>{
      const tr = document.createElement('tr');

      let td = document.createElement('td'); td.textContent = artist || ''; tr.appendChild(td);
      td = document.createElement('td'); td.textContent = title || ''; tr.appendChild(td);
      td = document.createElement('td'); td.textContent = note || ''; tr.appendChild(td);

      td = document.createElement('td');
      if (/^https?:\/\/\S+$/i.test(link||'')) {
        const a = document.createElement('a'); a.href = link; a.target = '_blank'; a.rel='noopener'; a.textContent = link;
        td.appendChild(a);
      } else { td.textContent = link || ''; }
      tr.appendChild(td);

      const tdOp = document.createElement('td');
      const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'コピー';
      btn.addEventListener('click', ()=> copyPair(title, artist));
      tdOp.appendChild(btn); tr.appendChild(tdOp);

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }

  async function copyPair(title, artist){
    const text = `${(title||'').trim()} / ${(artist||'').trim()}`.trim();
    try{
      if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
      else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
      showToast('コピーしました：' + text);
    } catch { showToast('コピーに失敗しました'); }
  }

  function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
  function $(id){ return document.getElementById(id); }

  (function load(){
    const s = document.createElement('script');
    s.src = buildGvizUrl();
    s.onerror = ()=> { $('status').textContent = 'データ取得に失敗しました'; };
    document.head.appendChild(s);
  })();

  $('q').addEventListener('input', scheduleSearch);
  $('limit').addEventListener('change', render);
  document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener('change', render));
</script>
</body>
</html>
